FROM jenkins/inbound-agent:latest
USER root

ARG TERRAFORM_VERSION=1.8.5
ARG MINIKUBE_VERSION=latest
ARG KUBECTL_VERSION=latest

# Basic packages + git + unzip
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg lsb-release apt-transport-https unzip jq make git python3 python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Docker CLI
RUN install -m0755 -d /etc/apt/keyrings \
 && curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc \
 && chmod a+r /etc/apt/keyrings/docker.asc \
 && echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian bookworm stable" \
    > /etc/apt/sources.list.d/docker.list \
 && apt-get update && apt-get install -y --no-install-recommends docker-ce-cli \
 && rm -rf /var/lib/apt/lists/*

# AWS CLI v2
RUN curl -sSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip \
  && unzip -q /tmp/awscliv2.zip -d /tmp \
  && /tmp/aws/install \
  && rm -rf /tmp/aws* /tmp/awscliv2.zip

# kubectl
RUN if [ "$KUBECTL_VERSION" = "latest" ]; then \
        KVERSION=$(curl -sSL https://dl.k8s.io/release/stable.txt); \
    else \
        KVERSION="$KUBECTL_VERSION"; \
    fi \
 && curl -sSL -o /usr/local/bin/kubectl "https://dl.k8s.io/release/${KVERSION}/bin/linux/amd64/kubectl" \
 && chmod +x /usr/local/bin/kubectl

# Terraform
RUN curl -sSL -o /tmp/terraform.zip \
        "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" \
    && unzip -q /tmp/terraform.zip -d /usr/local/bin \
    && rm -f /tmp/terraform.zip

# Minikube
RUN if [ "$MINIKUBE_VERSION" = "latest" ]; then \
        curl -sSL -o minikube "https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64"; \
    else \
        curl -sSL -o minikube "https://storage.googleapis.com/minikube/releases/${MINIKUBE_VERSION}/minikube-linux-amd64"; \
    fi \
    && install minikube /usr/local/bin/minikube \
    && rm -f minikube

# ---------------------------------------
# FIX: Ensure Jenkins workspace directory exists
# ---------------------------------------
RUN mkdir -p /var/jenkins_home/workspace \
    && chown -R jenkins:jenkins /var/jenkins_home

# Switch back to Jenkins user
USER jenkins

# FIX: Set working directory to match Jenkins master
WORKDIR /var/jenkins_home/workspace
